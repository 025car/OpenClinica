<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
	<changeSet author="ywang" id="2011-02-08-7181-1">
		<preConditions onFail="MARK_RAN">
  			<columnExists columnName="simple_conditional_display" tableName="item_form_metadata" schemaName="public"/>
		</preConditions>
		<comment>Insert into scd_item_metadata </comment>
		<sql splitStatements="false">
		insert into scd_item_metadata (scd_item_form_metadata_id,control_item_name,option_value,message)
		(select ifmd.item_form_metadata_id as scd_item_form_metadata_id,
			(trim(substr(ifmd.simple_conditional_display, 0, position(',' in ifmd.simple_conditional_display)))
			) as control_item_name,
			(trim (substr(ifmd.simple_conditional_display, position(',' in ifmd.simple_conditional_display)+1,
			 position(',' in substr(ifmd.simple_conditional_display,position(',' in ifmd.simple_conditional_display)+1))-1
			))
			) as option_value,
			(trim(substr( substr(ifmd.simple_conditional_display, position(',' in ifmd.simple_conditional_display)+1),
			 position(',' in substr(ifmd.simple_conditional_display,position(',' in ifmd.simple_conditional_display)+1))+1))
			) as message
		from item_form_metadata ifmd where length(ifmd.simple_conditional_display) > 0 
		order by ifmd.item_form_metadata_id)
		</sql>
	</changeSet>
	<changeSet author="ywang" id="2011-02-08-7181-2" dbms="oracle">
		<preConditions onFail="MARK_RAN">
  			<columnExists columnName="simple_conditional_display" tableName="item_form_metadata" schemaName="public"/>
		</preConditions>
		<comment>Insert into scd_item_metadata </comment>
		<sql splitStatements="false">
		insert into scd_item_metadata (scd_item_form_metadata_id,control_item_name,option_value,message)
		(select ifmd.item_form_metadata_id as scd_item_form_metadata_id,
			(trim(substr(ifmd.simple_conditional_display, 1, 
				instr(ifmd.simple_conditional_display,',')-1))
			) as control_item_name,
			(trim(substr (ifmd.simple_conditional_display,
			     instr(ifmd.simple_conditional_display, ',')+1,
			     instr(ifmd.simple_conditional_display,',',1,2)-instr(ifmd.simple_conditional_display, ',')-1 ) )
			) as option_value,
			(trim(substr (ifmd.simple_conditional_display,instr(ifmd.simple_conditional_display,',',1,2)+1,
			      length(ifmd.simple_conditional_display)-instr(ifmd.simple_conditional_display,',',1,2) ) )
			) as message
		from item_form_metadata ifmd
		where length(ifmd.simple_conditional_display) > 0
		order by ifmd.item_form_metadata_id)
		</sql>
	</changeSet>
	<changeSet author="ywang" id="2011-02-08-7181-3">
		<preConditions onFail="MARK_RAN">
			<columnExists columnName="simple_conditional_display" tableName="item_form_metadata" schemaName="public"/>
		</preConditions>
		<comment>Update scd_item_metadata</comment>
		<sql splitStatements="false">
		update scd_item_metadata set control_item_form_metadata_id = 
		(select cifm.item_form_metadata_id from item, item_form_metadata cifm
				 where item.name = scd_item_metadata.control_item_name 
					and cifm.item_id = item.item_id
					and cifm.section_id = (select sifm.section_id from item_form_metadata sifm 
							where sifm.item_form_metadata_id = scd_item_metadata.scd_item_form_metadata_id)
		) 
		</sql>
	</changeSet>
	<changeSet author="ywang" id="2011-02-08-7181-4">
		<preConditions onFail="MARK_RAN">
			<columnExists columnName="simple_conditional_display" tableName="item_form_metadata" schemaName="public"/>
		</preConditions>
		<comment>Drop simple_conditional_display column if exists</comment>
		<dropColumn tableName="item_form_metadata" columnName="simple_conditional_display"/>
	</changeSet>
</databaseChangeLog>