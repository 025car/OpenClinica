<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9 http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">

     <changeSet author="drodrigues" id="2012-05-02-14122-1" dbms="postgresql">
        <comment>Dropping old view definitions.</comment>
        <sql splitStatements="true">
<![CDATA[
drop view view_discrepancy_note;
drop view view_dn_item_data;
drop view view_dn_event_crf;
drop view view_dn_study_event;
drop view view_dn_study_subject;
drop view view_dn_subject;
]]>
        </sql>
    </changeSet>

     <changeSet author="drodrigues" id="2012-05-02-14122-2" dbms="postgresql">
        <comment>Adding new columns to 'view_dn_item_data'.</comment>
        <sql splitStatements="true">
<![CDATA[
create or replace view view_dn_item_data as select 
s.study_id, 
s.parent_study_id, 
vstudy.hide_crf as "study_hide_crf",
vsite.hide_crf as "site_hide_crf",
dn.discrepancy_note_id, 
i.item_id as "entity_id",
map.column_name,
ss.study_subject_id,
ss.label, 
ss.status_id as "ss_status_id",
dn.discrepancy_note_type_id,
dn.resolution_status_id, 
s.unique_identifier as "site_id", 
ds.date_created,
ds.date_updated,
ds.days, 
ds.age, 
sed.name as "event_name", 
se.date_start, 
c.name as "crf_name", 
ec.status_id, 
i.name as "entity_name", 
id.value, 
dn.entity_type, 
dn.description, 
dn.detailed_notes, 
ds.total_notes,
ua.first_name, 
ua.last_name, 
ua.user_name,
ua2.first_name as "owner_first_name", 
ua2.last_name as "owner_last_name", 
ua2.user_name as "owner_user_name"
from 
dn_item_data_map map
join discrepancy_note dn on (dn.discrepancy_note_id = map.discrepancy_note_id and dn.entity_type = 'itemData' and ((dn.parent_dn_id is null) or (dn.parent_dn_id = 0)))
join view_dn_stats ds on (dn.discrepancy_note_id = ds.discrepancy_note_id)
join user_account ua2 on (dn.owner_id = ua2.user_id)
join item_data id on (map.item_data_id = id.item_data_id)
join item i on (id.item_id = i.item_id)
join event_crf ec on (id.event_crf_id = ec.event_crf_id)
join study_event se on (ec.study_event_id = se.study_event_id)
join crf_version cv on (ec.crf_version_id = cv.crf_version_id)
join view_site_hidden_event_definition_crf vsite on (vsite.study_event_id = se.study_event_id and vsite.crf_version_id = cv.crf_version_id)
join view_study_hidden_event_definition_crf vstudy on (vstudy.study_event_id = se.study_event_id and vstudy.crf_version_id = cv.crf_version_id)
join study_event_definition sed on (se.study_event_definition_id = sed.study_event_definition_id)
join crf c on (cv.crf_id = c.crf_id)
join study_subject ss on (se.study_subject_id = ss.study_subject_id)
join study s on (ss.study_id = s.study_id)
left join user_account ua on (dn.assigned_user_id = ua.user_id);

]]>
        </sql>
    </changeSet>

     <changeSet author="drodrigues" id="2012-05-02-14122-3" dbms="postgresql">
        <comment>Adding new columns to 'view_dn_event_crf'.</comment>
        <sql splitStatements="true">
<![CDATA[
create or replace view view_dn_event_crf as 
select 
s.study_id, 
s.parent_study_id, 
vstudy.hide_crf as "study_hide_crf", 
vsite.hide_crf as "site_hide_crf",
dn.discrepancy_note_id, 
ec.event_crf_id as "entity_id",
map.column_name,
ss.study_subject_id,
ss.label, 
ss.status_id as "ss_status_id",
dn.discrepancy_note_type_id,
dn.resolution_status_id, 
s.unique_identifier as "site_id", 
ds.date_created,
ds.date_updated,
ds.days, 
ds.age, 
sed.name as "event_name", 
se.date_start, 
c.name as "crf_name", 
ec.status_id, 
map.column_name as "entity_name",
case
    when map.column_name = 'date_interviewed' then to_char(ec.date_interviewed, 'YYYY-MM-DD')
    when map.column_name = 'interviewer_name' then ec.interviewer_name
    else TRIM('')
end as "value", 
dn.entity_type, 
dn.description, 
dn.detailed_notes, 
ds.total_notes,
ua.first_name, 
ua.last_name, 
ua.user_name,
ua2.first_name as "owner_first_name", 
ua2.last_name as "owner_last_name", 
ua2.user_name as "owner_user_name"
from
dn_event_crf_map map
join discrepancy_note dn on (dn.discrepancy_note_id = map.discrepancy_note_id and dn.entity_type = 'eventCrf' and ((dn.parent_dn_id is null) or (dn.parent_dn_id = 0)))
join view_dn_stats ds on (dn.discrepancy_note_id = ds.discrepancy_note_id)
join user_account ua2 on (dn.owner_id = ua2.user_id)
join event_crf ec on (map.event_crf_id = ec.event_crf_id)
join study_event se on (ec.study_event_id = se.study_event_id)
join crf_version cv on (ec.crf_version_id = cv.crf_version_id)
join view_site_hidden_event_definition_crf vsite on (vsite.study_event_id = se.study_event_id and vsite.crf_version_id = cv.crf_version_id)
join view_study_hidden_event_definition_crf vstudy on (vstudy.study_event_id = se.study_event_id and vstudy.crf_version_id = cv.crf_version_id)
join study_event_definition sed on (se.study_event_definition_id = sed.study_event_definition_id)
join crf c on (cv.crf_id = c.crf_id)
join study_subject ss on (se.study_subject_id = ss.study_subject_id)
join study s on (ss.study_id = s.study_id)
left join user_account ua on (dn.assigned_user_id = ua.user_id);

]]>
        </sql>
    </changeSet>

     <changeSet author="drodrigues" id="2012-05-02-14122-4" dbms="postgresql">
        <comment>Adding new columns to 'view_dn_event_crf'.</comment>
        <sql splitStatements="true">
<![CDATA[
create or replace view view_dn_study_event as 
select 
s.study_id, 
s.parent_study_id, 
false as "study_hide_crf", 
false as "site_hide_crf",
dn.discrepancy_note_id, 
se.study_event_id as "entity_id",
map.column_name,
ss.study_subject_id,
ss.label, 
ss.status_id as "ss_status_id",
dn.discrepancy_note_type_id, 
dn.resolution_status_id, 
s.unique_identifier as "site_id",
ds.date_created,
ds.date_updated,
ds.days, 
ds.age,
sed.name as "event_name", 
se.date_start,
TRIM('') as "crf_name",
0 as "status_id",
map.column_name as "entity_name",
case
    when map.column_name = 'start_date' then to_char(se.date_start, 'YYYY-MM-DD')
    when map.column_name = 'end_date' then to_char(se.date_end, 'YYYY-MM-DD')
    when map.column_name = 'location' then se.location
    else TRIM('')
end as "value", 
dn.entity_type,
dn.description,
dn.detailed_notes,
ds.total_notes,
ua.first_name, 
ua.last_name, 
ua.user_name,
ua2.first_name as "owner_first_name", 
ua2.last_name as "owner_last_name", 
ua2.user_name as "owner_user_name"
from
dn_study_event_map map
join discrepancy_note dn on (dn.discrepancy_note_id = map.discrepancy_note_id and dn.entity_type = 'studyEvent' and ((dn.parent_dn_id is null) or (dn.parent_dn_id = 0)))
join view_dn_stats ds on (dn.discrepancy_note_id = ds.discrepancy_note_id)
join user_account ua2 on (dn.owner_id = ua2.user_id)
join study_event se on (map.study_event_id = se.study_event_id)
join study_subject ss on (se.study_subject_id = ss.study_subject_id)
join study s on (ss.study_id = s.study_id)
join study_event_definition sed on (se.study_event_definition_id = sed.study_event_definition_id)
left join user_account ua on (dn.assigned_user_id = ua.user_id)
;

]]>
        </sql>
    </changeSet>

     <changeSet author="drodrigues" id="2012-05-02-14122-5" dbms="postgresql">
        <comment>Adding new columns to 'view_dn_event_crf'.</comment>
        <sql splitStatements="true">
<![CDATA[
create or replace view view_dn_study_subject as 
select 
s.study_id, 
s.parent_study_id, 
false as "study_hide_crf", 
false as "site_hide_crf",
dn.discrepancy_note_id, 
ss.study_subject_id as "entity_id",
map.column_name,
ss.study_subject_id,
ss.label, 
ss.status_id as "ss_status_id",
dn.discrepancy_note_type_id, 
dn.resolution_status_id, 
s.unique_identifier as "site_id",
ds.date_created,
ds.date_updated,
ds.days, 
ds.age, 
TRIM('') as "event_name", 
null::date as "date_start",
TRIM('') as "crf_name",
0 as "status_id", 
map.column_name as "entity_name", 
to_char(ss.enrollment_date, 'YYYY-MM-DD') as "value", 
dn.entity_type,
dn.description, 
dn.detailed_notes,
ds.total_notes,
ua.first_name, 
ua.last_name, 
ua.user_name,
ua2.first_name as "owner_first_name", 
ua2.last_name as "owner_last_name", 
ua2.user_name as "owner_user_name"
from 
dn_study_subject_map map
join discrepancy_note dn on (dn.discrepancy_note_id = map.discrepancy_note_id and dn.entity_type = 'studySub' and ((dn.parent_dn_id is null) or (dn.parent_dn_id = 0)))
join view_dn_stats ds on (dn.discrepancy_note_id = ds.discrepancy_note_id)
join user_account ua2 on (dn.owner_id = ua2.user_id)
join study_subject ss on (map.study_subject_id = ss.study_subject_id)
join study s on (ss.study_id = s.study_id)
left join user_account ua on (dn.assigned_user_id = ua.user_id)
;

]]>
        </sql>
    </changeSet>

     <changeSet author="drodrigues" id="2012-05-02-14122-6" dbms="postgresql">
        <comment>Adding new columns to 'view_dn_event_crf'.</comment>
        <sql splitStatements="true">
<![CDATA[
create or replace view view_dn_subject as 
select 
s.study_id, 
s.parent_study_id, 
false as "study_hide_crf", 
false as "site_hide_crf",
dn.discrepancy_note_id,
su.subject_id as "entity_id",
map.column_name,
ss.study_subject_id,
ss.label, 
ss.status_id as "ss_status_id",
dn.discrepancy_note_type_id, 
dn.resolution_status_id, 
s.unique_identifier as "site_id",
ds.date_created,
ds.date_updated,
ds.days, 
ds.age, 
TRIM('') as "event_name", 
null::date as "date_start",
TRIM('') as "crf_name", 
0 as "status_id", 
map.column_name as "entity_name",
case
    when map.column_name = 'unique_identifier' then su.unique_identifier
    when map.column_name = 'gender' then su.gender
    when map.column_name = 'date_of_birth' then to_char(su.date_of_birth, 'YYYY-MM-DD')
    else TRIM('')
end as "value", 
dn.entity_type,
dn.description,
dn.detailed_notes,
ds.total_notes,
ua.first_name, 
ua.last_name, 
ua.user_name,
ua2.first_name as "owner_first_name", 
ua2.last_name as "owner_last_name", 
ua2.user_name as "owner_user_name"
from
dn_subject_map map
join discrepancy_note dn on (dn.discrepancy_note_id = map.discrepancy_note_id and dn.entity_type = 'subject' and ((dn.parent_dn_id is null) or (dn.parent_dn_id = 0)))
join view_dn_stats ds on (dn.discrepancy_note_id = ds.discrepancy_note_id)
join user_account ua2 on (dn.owner_id = ua2.user_id)
join subject su on (map.subject_id = su.subject_id)
join study_subject ss on (su.subject_id = ss.subject_id)
join study s on (ss.study_id = s.study_id)
left join user_account ua on (dn.assigned_user_id = ua.user_id)
;

]]>
        </sql>
    </changeSet>

     <changeSet author="drodrigues" id="2012-05-02-14122-7" dbms="postgresql">
        <comment>Recreating 'view_discrepancy_note'.</comment>
        <sql splitStatements="true">
<![CDATA[
create or replace view view_discrepancy_note as 
select * from view_dn_item_data
union all
select * from view_dn_event_crf
union all
select * from view_dn_study_event
union all
select * from view_dn_study_subject
union all
select * from view_dn_subject;

]]>
        </sql>
    </changeSet>

</databaseChangeLog>     